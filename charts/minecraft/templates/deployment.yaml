{{- include "common.Deployment" (list . "minecraft.Deployment") -}}

{{- define "minecraft.Deployment" -}}
spec:
  template:
    spec:
      dnsPolicy: Default
      containers:
        - name: minecraft
          image: itzg/minecraft-server
          ports:
            - name: minecraft
              containerPort: 25565
          env:
            - name: EULA
              value: "true"
            - name: STOP_SERVER_ANNOUNCE_DELAY
              value: "30"
            - name: STOP_DURATION
              value: "30"
            - name: INIT_MEMORY
              value: {{ .Values.serverOptions.memory.initial | quote }}
            - name: MAX_MEMORY
              value: {{ .Values.serverOptions.memory.max | quote }}
            - name: OPS
              value: {{ .Values.serverOptions.operators | quote }}
            - name: SERVER_NAME
              value: {{ .Values.serverOptions.branding.serverName | quote }}
            - name: MOTD
              value: {{ .Values.serverOptions.branding.motd | quote }}
            - name: ICON
              value: {{ .Values.serverOptions.branding.icon | quote }}
            - name: MAX_WORLD_SIZE
              value: {{ .Values.serverOptions.overworld.radius | quote }}
            - name: MODE
              value: {{ .Values.serverOptions.gameplay.gamemode | quote }}
            - name: VIEW_DISTANCE
              value: {{ .Values.serverOptions.gameplay.viewDistance | quote }}
            - name: DIFFICULTY
              value: {{ .Values.serverOptions.gameplay.difficulty | quote }}
            - name: SPAWN_PROTECTION
              value: {{ .Values.serverOptions.gameplay.spawnProtection | quote }}
            - name: VERSION
              value: {{ .Values.serverOptions.server.version | quote }}
            - name: MAX_PLAYERS
              value: {{ .Values.serverOptions.server.maxPlayers | quote }}
            - name: TZ
              value: {{ .Values.serverOptions.server.timezone | quote }}
            - name: TYPE
              value: {{ .Values.serverOptions.server.jreType | quote }}
          {{ if .Values.serverOptions.whitelist.enabled }}
            - name: ENABLE_WHITELIST
              value: "true"
            - name: WHITELIST
              value: {{ .Values.serverOptions.whitelist.players | quote }}
          {{- end -}}
          {{ if .Values.serverOptions.overworld.generateStructures }}
            - name: GENERATE_STRUCTURES
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.nether.enabled }}
            - name: ALLOW_NETHER
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.enableCommandBlocks }}
            - name: ENABLE_COMMAND_BLOCK
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.hardcore }}
            - name: HARDCORE
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.pvpEnabled }}
            - name: PVP
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.spawnAnimals }}
            - name: SPAWN_ANIMALS
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.spawnMonsters }}
            - name: SPAWN_MONSTERS
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.gameplay.spawnNpcs }}
            - name: SPAWN_NPCS
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.server.announceAchievements }}
            - name: ANNOUNCE_PLAYER_ACHIEVEMENTS
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.server.snooperEnabled }}
            - name: SNOOPER_ENABLED
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.server.onlineMode }}
            - name: ONLINE_MODE
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.server.allowFlight }}
            - name: ALLOW_FLIGHT
              value: "true"
          {{ end }}
          {{ if .Values.serverOptions.server.autoPause }}
            - name: ENABLE_AUTOPAUSE
              value: "true"
          {{ end }}
          {{ if eq .Values.serverOptions.server.jreType "AUTO_CURSEFORGE" }}
            - name: CF_PAGE_URL
              value: {{ .Values.serverOptions.curseforge.modpackUrl | quote }}
          {{ end }}
          envFrom:
          {{ range $secret := .Values.secretEnvs }}
            - secretRef:
                name: {{ tpl $secret . }}
          {{ end }}
          volumeMounts:
            - name: data
              mountPath: /data
              readOnly: false
      
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: {{ tpl .Values.pvcName . }}
            readOnly: false
{{- end -}}